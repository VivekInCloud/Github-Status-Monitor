name: GitHub Status Monitor

on:
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (to persist incident state)
        uses: actions/checkout@v3

      - name: Check GitHub Status and notify Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set -e

          DATA=$(curl -s https://www.githubstatus.com/api/v2/incidents/unresolved.json)
          COUNT=$(echo "$DATA" | jq '.incidents | length')

          if [ "$COUNT" -eq 0 ]; then
            echo "No active incidents. Clearing state."
            rm -f previous_incidents.txt
            exit 0
          fi

          # Store current incident IDs
          echo "$DATA" | jq -r '.incidents[].id' > current_incidents.txt

          # Compare with previous run
          if [ -f previous_incidents.txt ]; then
            PERSISTENT=$(comm -12 <(sort previous_incidents.txt) <(sort current_incidents.txt))
          else
            PERSISTENT=""
          fi

          # Alert only if incidents persist
          if [ -n "$PERSISTENT" ]; then
            MESSAGE="ðŸš¨ GitHub Incident Still Active\n\n"

            for ID in $PERSISTENT; do
              INCIDENT=$(echo "$DATA" | jq ".incidents[] | select(.id==\"$ID\")")

              NAME=$(echo "$INCIDENT" | jq -r '.name')
              STATUS=$(echo "$INCIDENT" | jq -r '.status')
              IMPACT=$(echo "$INCIDENT" | jq -r '.impact')

              MESSAGE+="â€¢ $NAME â€” $STATUS ($IMPACT)\n"
            done

            MESSAGE+="\nðŸ”— https://www.githubstatus.com/"

            curl -X POST \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg text "$MESSAGE" '{text: $text}')" \
              "$SLACK_WEBHOOK_URL"
          else
            echo "Incident detected, but waiting for confirmation in next iteration."
          fi

          # Update baseline for next run
          mv current_incidents.txt previous_incidents.txt

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add previous_incidents.txt
          git commit -m "Update incident state" || true
          git push || true 
